#!/usr/bin/env bash

set -e
set -o pipefail

# Needs to match patrick-web.service
export GEM_HOME=/home/ubuntu/.gem/ruby/3.0.2

id -u patrick &>/dev/null || sudo useradd patrick

curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list

sudo apt-get update -yq
sudo apt-get install software-properties-common -yq
curl -s https://deb.nodesource.com/gpgkey/nodesource.gpg.key | sudo apt-key add -
DISTRO=$(lsb_release -c -s)
echo "deb https://deb.nodesource.com/node_18.x ${DISTRO} main" | sudo tee /etc/apt/sources.list.d/nodesource.list
echo "deb-src https://deb.nodesource.com/node_18.x ${DISTRO} main" | sudo tee -a /etc/apt/sources.list.d/nodesource.list

sudo apt-get update -yq
sudo apt-get install gcc g++ libxml2 libpq-dev make nginx nodejs ruby ruby-dev ruby-bundler yarn python3-certbot-nginx -yq
sudo apt-get remove certbot -yq
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
sudo snap install core
sudo snap refresh core
sudo apt autoremove -yq

sudo certbot renew --dry-run

sudo cp resources/nginx.conf /etc/nginx/nginx.conf
sudo cp resources/patrick-web.service /etc/systemd/system/patrick-web.service
sudo systemctl enable patrick-web

# Trim logs
# TODO(patrick): Put this in cron
sudo journalctl --vacuum-size=1G

sudo systemctl daemon-reload
sudo mkdir -p /home/ubuntu/website/log
sudo chmod 0664 -R /home/ubuntu/website/log
sudo chmod 0774 /home/ubuntu/website/log
sudo chown -R ubuntu /home/ubuntu/website/log
sudo chgrp -R ubuntu /home/ubuntu/website/log
sudo touch /var/log/patrick-web.log
sudo chown patrick /var/log/patrick-web.log

# TODO(patrick): Find a better location for this
mkdir -p /home/ubuntu/website/tmp
chmod -R 777 /home/ubuntu/website/tmp

sudo gem install bundler
bundle install

# TODO(patrick): Generate config/secrets.yml

RAILS_ENV=production bundle exec rake assets:precompile

sudo service nginx restart
sudo service patrick-web restart

# TODO(patrick): Initialize certbot
