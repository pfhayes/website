#!/usr/bin/env bash

id -u patrick &>/dev/null || sudo useradd patrick 

curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list

sudo apt-get update -yq
sudo apt-get install software-properties-common -yq
sudo add-apt-repository ppa:certbot/certbot -yq
curl -s https://deb.nodesource.com/gpgkey/nodesource.gpg.key | sudo apt-key add -
DISTRO=$(lsb_release -c -s)
echo "deb https://deb.nodesource.com/node_10.x ${DISTRO} main" | sudo tee /etc/apt/sources.list.d/nodesource.list
echo "deb-src https://deb.nodesource.com/node_10.x ${DISTRO} main" | sudo tee -a /etc/apt/sources.list.d/nodesource.list

sudo apt-get update
sudo apt-get install gcc g++ libxml2 libpq-dev make nginx nodejs ruby ruby-dev ruby-bundler yarn python-certbot-nginx -yq
sudo apt autoremove

sudo cp resources/nginx.conf /etc/nginx/nginx.conf
sudo cp resources/service.conf /etc/init/patrick-web.conf

sudo service nginx restart
sudo service patrick-web restart

gem install bundler
bundle install

# TODO(patrick): Generate config/secrets.yml
# TODO(patrick): Initialize certbot
